<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Foreign functions</title>
    <meta name="description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://melt.cs.umn.edu/concepts/ffi/">
    
    <script src="/js/nav.js"></script>
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Silver Documentation</a>

  </div>

</header>


    <div class="site-nav">
      

<ul class="nav">

    
    <li>
    
        <a href="doc/">Home</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/install-guide/">Installation guide</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/command-line-reference/">Command line reference</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/faq/">Frequently asked questions (FAQ)</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/error-faq/">Frequently found errors (FFE)</a>
    
    
    </li>

    
    <li class="collapsible collapsed">
    
        Tutorials (TODO)
    
    
        

<ul class="nav">

    
    <li>
    
        Intro to AGs - dc?
    
    
    </li>

    
    <li>
    
        Simple
    
    
    </li>

</ul>

    
    </li>

    
    <li class="collapsible collapsed">
    
        Concepts
    
    
        

<ul class="nav">

    
    <li>
    
        Attribute grammars
    
    
    </li>

    
    <li>
    
        <a href="doc/concepts/decorated-vs-undecorated/">Decorated vs undecorated</a>
    
    
    </li>

    
    <li>
    
        Forwarding
    
    
    </li>

    
    <li>
    
        <a href="doc/concepts/aspects/">Aspects</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/concepts/collections/">Collection attributes</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/concepts/modules/">The module system</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/concepts/types/">Types</a>
    
    
    </li>

    
    <li>
    
        Concrete syntax
    
    
    </li>

    
    <li>
    
        <a href="doc/concepts/io/">IO</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/concepts/lr-parsing/">LR parsing</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/concepts/ffi/">Foreign Function Interface</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/concepts/modular-well-definedness/">Modular well-definedness</a>
    
    
    </li>

</ul>

    
    </li>

    
    <li class="collapsible collapsed">
    
        Language reference
    
    
        

<ul class="nav">

    
    <li class="collapsible collapsed">
    
        Declarations
    
    
        

<ul class="nav">

    
    <li>
    
        <a href="doc/ref/decl/nonterminals/">Nonterminals</a>
    
    
    </li>

    
    <li class="collapsible collapsed">
    
        <a href="doc/ref/decl/productions/">Productions</a>
    
    
        

<ul class="nav">

    
    <li>
    
        <a href="doc/ref/decl/productions/concrete/">Concrete</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/ref/decl/productions/aspect/">Aspect</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/ref/decl/productions/default/">Default</a>
    
    
    </li>

</ul>

    
    </li>

    
    <li>
    
        <a href="doc/ref/decl/attributes/">Attributes</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/ref/decl/occurs/">Occurs</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/ref/decl/functions/">Functions</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/ref/decl/globals/">Global values</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/ref/decl/types/">Type declarations</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/ref/decl/parsers/">Parser declarations</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/ref/decl/terminals/">Terminals</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/ref/decl/annotations/">Annotations</a>
    
    
    </li>

    
    <li class="collapsible collapsed">
    
        Copper-specific
    
    
        

<ul class="nav">

    
    <li>
    
        <a href="doc/ref/decl/copper/parser-attribute/">Parser attributes</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/ref/decl/copper/lexer-class/">Lexer classes</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/ref/decl/copper/disambiguate/">Disambiguation functions</a>
    
    
    </li>

</ul>

    
    </li>

</ul>

    
    </li>

    
    <li class="collapsible collapsed">
    
        Production body
    
    
        

<ul class="nav">

    
    <li>
    
        <a href="doc/ref/stmt/equations/">Equations</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/ref/stmt/forwarding/">Forwards to</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/ref/stmt/locals/">Locals</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/ref/stmt/return/">Return</a>
    
    
    </li>

    
    <li class="collapsible collapsed">
    
        Copper-specific
    
    
        

<ul class="nav">

    
    <li>
    
        <a href="doc/ref/stmt/copper/pluck/">Pluck</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/ref/stmt/copper/print/">Print</a>
    
    
    </li>

</ul>

    
    </li>

</ul>

    
    </li>

    
    <li class="collapsible collapsed">
    
        Expressions
    
    
        

<ul class="nav">

    
    <li>
    
        <a href="doc/ref/expr/calls/">Function/production application</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/ref/expr/attribute-access/">Attribute access</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/ref/expr/booleans/">Boolean expressions</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/ref/expr/comparisons/">Comparison operators</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/ref/expr/numeric/">Numeric expressions</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/ref/expr/decorate/">Decorate with</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/ref/expr/new/">New (undecorate)</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/ref/expr/terminal/">Terminal literals</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/ref/expr/pattern-matching/">Pattern matching</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/ref/expr/let/">Lets</a>
    
    
    </li>

</ul>

    
    </li>

    
    <li class="collapsible collapsed">
    
        Extensions
    
    
        

<ul class="nav">

    
    <li>
    
        List syntax
    
    
    </li>

    
    <li>
    
        <a href="doc/ref/ext/easy-terminal/">Easy terminals</a>
    
    
    </li>

    
    <li>
    
        Convenience
    
    
    </li>

</ul>

    
    </li>

</ul>

    
    </li>

    
    <li class="collapsible collapsed">
    
        Library reference
    
    
        

<ul class="nav">

    
    <li>
    
        <a href="doc/lib/string/">String</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/lib/pair/">Pair</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/lib/list/">List</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/lib/maybe/">Maybe</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/lib/io/">IO</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/lib/document-pp/">Document (pp)</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/lib/other/">Other</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/lib/comparison/">Comparison fns</a>
    
    
    </li>

</ul>

    
    </li>

    
    <li>
    
        <a href="doc/bibliography/">Bibliography</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/style-guide/">Style guide</a>
    
    
    </li>

    
    <li class="collapsible collapsed">
    
        Development
    
    
        

<ul class="nav">

    
    <li>
    
        <a href="doc/dev/building/">Building Silver</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/dev/code-organization/">Code organization</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/dev/runtime-editing/">Runtime development</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/dev/long-term-todo/">Silver popularity todo list</a>
    
    
    </li>

    
    <li class="collapsible collapsed">
    
        Eclipse
    
    
        

<ul class="nav">

    
    <li>
    
        <a href="doc/dev/eclipse/getting-started/">Getting started</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/dev/eclipse/ide-decl/">Creating an IDE plugin</a>
    
    
    </li>

    
    <li>
    
        <a href="doc/dev/eclipse/internals/">Eclipse internals docs</a>
    
    
    </li>

</ul>

    
    </li>

</ul>

    
    </li>

</ul>

    </div>

    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Foreign functions</h1>
  </header>

  <article class="post-content">
    <h2 id="adding-dependencies-to-your-silver-jar">Adding dependencies to your Silver jar</h2>

<p>There is a flag you can pass on the command line, when building a jar using Silver, to depend on another external jar file:</p>

<pre><code>silver --include-jar ./path/to/extra/file.jar  some:grammar
</code></pre>

<p>This will include that jar in the class path and have the usual effect based on the current build mode:</p>

<ul>
  <li>default: the generated jar will have a full path to that jar in its classpath</li>
  <li><code>--relative-jar</code>: the generated jar will expect to be run with that jar placed in the same directory as itself (including the SilverRuntime and CopperRuntime jars, too.)</li>
  <li><code>--one-jar</code>: the generated jar will have the contents of the other jar included within itself.</li>
</ul>

<p>i.e. the same effect these flags have on the runtime jars, will also happen to this jar passed via <code>--include-jar</code>.</p>

<ul>
  <li><strong>TODO</strong> This is a terrible way to depend on other jars, but fixing it will have to wait until we have a proper Silver packaging system. Somehow, the code that needs a jar should itself require the jar, rather than the builder having to pass this along.</li>
</ul>

<h2 id="creating-foreign-types-within-silver">Creating foreign types within Silver</h2>

<p>Types can be declared as Java types within Silver by writing:</p>

<pre><code>type MyType foreign;
</code></pre>

<ul>
  <li><strong>TODO</strong> Currently, there is no way to specify the Java type, and as a result it is always passed around as Object and you have to do a lot of casting yourself. This should change, eventually.</li>
</ul>

<h2 id="creating-foreign-functions-within-silver">Creating foreign functions within Silver</h2>

<p>A function can have its implementation be just Java source code using a declaration like the following:</p>

<pre><code>function append
[a] ::= l1::[a] l2::[a]
{
  return error("Not Yet Implemented: append");
} foreign {
  "java" : return "common.AppendCell.append(%l1%, %?l2?%)";
}
</code></pre>

<ul>
  <li>Every Java type should be referred to using its full package path. There is no way to add addition “import” statements or the like.</li>
  <li>Parameters referred to using <code>%name%</code> are <em>demanded</em>. That is, any thunk is evaluated before the result is used. As a return, the corresponding Java type is known (unless, of course, the parameter’s type is a foreign type, which currently are all <code>Object</code>.)</li>
  <li>
    <p>Parameters referred to using <code>%?name?%</code> are <em>not</em> demanded. The receiver may get the value directly, <strong>or</strong> it may get a thunk that will eval to the desired value. This allows foreign java functions to be lazy in an argument, if desired. (Above, <code>append</code> is strict in its first argument, but lazy in its second.) Because of this, these values are all of type <code>Object</code>.</p>
  </li>
  <li><strong>TODO</strong> There is really no reason we should have a “normal” function body. We should remove that.</li>
</ul>

<h2 id="calling-silver-from-java">Calling Silver from Java</h2>

<p>This is semi-intentionally not documented here. The Silver runtime is subject to change, always.</p>

<p>However, there are good examples of doing so. Primarily, our silver-eclipse runtime calls from Java code into Silver, and there are examples in the silver runtime of doing so as well. Reading over the entirety of the <code>common</code> and <code>common.javainterop</code> packages in the SilverRuntime will be helpful. These should have some JavaDoc as well (if there is insufficient api documentation somewhere in there, please file a bug!)</p>

<p>General notes, however:</p>

<ul>
  <li>There is are <code>Init</code> calls that need to be made before Silver stuff can be used.</li>
  <li>You need to take <code>Node</code> objects and convert to <code>DecoratedNode</code> in order to access attributes.</li>
</ul>

<h2 id="building-java-code-that-depends-on-silver-code">Building Java code that depends on Silver code</h2>

<p>You have a chicken, and an egg. This will be fun.</p>

<p>As an illustration, here is how we build the Silver runtime jar:</p>

<ol>
  <li>Build the <code>core</code> grammar to java code, but pause before trying to build that.</li>
  <li>Add the generated <code>.java</code> files from <code>core</code> to the build path for the silver runtime, build all these java files at once.</li>
  <li>Take only those built <code>.class</code> files that are part of the runtime, not part of <code>core</code>, and put those into the <code>SilverRuntime.jar</code></li>
</ol>

<p>So, the general technique is to simultaneously build the silver-generated java files and your own java code, but then extract from that only your code’s class files to distribute.</p>

<h2 id="long-term-ffi-todo">Long term FFI TODO</h2>

<p>We should some day be able to import java types directly, rather than have to write a lot of annoying foreign functions.</p>

<p>e.g. <code>foreign import java.lang.String;</code></p>

<p>The idea is that this would:</p>

<ul>
  <li>Automatically create the appropriate foreign types in the Silver environment. Not just for <code>java.lang.String</code> but also for all types its methods reference.</li>
  <li>Create all the foreign functions for static functions / methods / constructors of that type.</li>
  <li>Mangle the types to adapt programming models. e.g. everything would be <code>Maybe&lt;a&gt;</code> where <code>a</code> is the corresponding foreign type, in order to accommodate nulls. All functions would be mangled into IO actions, because who knows what manipulates state.</li>
  <li>Translate some common types automatically (strings, integers, booleans)</li>
  <li>Recognize any references to Silver runtime types, and translate those back appropriately. (e.g. ConsCell, NIOVal)</li>
  <li>Recognize Java annotations about null or function purity, and use those to avoid doing the above where possible.</li>
</ul>

<p>Silver is missing a lot of features we’d want before we tried this, though.</p>

<p>This would eliminate the need to write strings of Java code that we do string substitution into. We’d also move type checking into the Silver compiler.</p>

<p>The model for using foreign functions wouldn’t change too much though. You’d never directly use a foreign import in a normal program, instead a Silver library would do it, and then declare the desired (probably less-messy) API to expose. Basically, like you do now.</p>

<p>Haskell almost does this sort of thing. Instead of importing (and presumably using the Java reflection stuff to inspect the class), you run a preprocessor that generates appropriate Haskell declarations from a C header file. Then you design the library’s API internally using calls to those functions.</p>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

  </div>

</footer>

<script>nav_hook();</script>


  </body>

</html>
